# Nixpacks configuration for Dokploy deployment (Laravel Backend)
# This file helps Dokploy build the Laravel application correctly

[phases.setup]
nixPkgs = ["php82", "nodejs_20"]

[phases.install]
cmds = [
  # Install Composer (nixpacks doesn't include composer in nixPkgs)
  "curl -sS https://getcomposer.org/installer | php && mv composer.phar /usr/local/bin/composer && chmod +x /usr/local/bin/composer || true",
  # Copy .env.example to .env if .env doesn't exist
  "cp .env.example .env || true",
  # Install Composer dependencies
  "composer install --no-dev --optimize-autoloader --no-interaction",
  # Install npm dependencies
  "npm install --legacy-peer-deps",
  # Build Vite assets
  "npm run build"
]

[phases.build]
cmds = [
  # Create storage directories first
  "mkdir -p storage/framework/sessions storage/framework/views storage/framework/cache/data storage/logs storage/app/public || true",
  # Setup storage permissions (775 for directories, 664 for files)
  "chmod -R 775 storage bootstrap/cache || true",
  "chmod -R 664 storage/logs/*.log 2>/dev/null || true",
  "touch storage/logs/laravel.log || true",
  "chmod 664 storage/logs/laravel.log || true",
  # Generate APP_KEY if not set (check if APP_KEY is empty or base64:)
  "php artisan key:generate --force || echo 'APP_KEY already exists or generation failed'",
  # Link storage
  "php artisan storage:link || true",
  # Run migrations (WARNING: This will run on every deployment!)
  "php artisan migrate --force || echo 'Migration failed or already up to date'",
  # Cache configuration
  "php artisan config:cache || true",
  "php artisan route:cache || true",
  "php artisan view:cache || true",
  "php artisan event:cache || true",
  # Package discovery
  "php artisan package:discover --ansi || true"
]

[start]
cmd = "php artisan serve --host=0.0.0.0 --port=${PORT:-8000}"

